<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiveKit MSA Server Test</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card h2 { margin-top: 0; color: #555; font-size: 18px; }
    button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
    button:hover { background: #0056b3; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
    button.success { background: #28a745; }
    button.success:hover { background: #218838; }
    button.warning { background: #ffc107; color: #000; }
    button.warning:hover { background: #e0a800; }
    button.active { animation: pulse 1s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; margin-bottom: 10px; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 13px; max-height: 300px; overflow-y: auto; }
    .status { padding: 5px 10px; border-radius: 4px; display: inline-block; margin-bottom: 10px; }
    .status.ok { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .room-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    .flex { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    #video-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; margin-top: 15px; }
    .video-box { background: #000; border-radius: 8px; aspect-ratio: 16/9; position: relative; overflow: hidden; }
    .video-box video { width: 100%; height: 100%; object-fit: cover; }
    .video-label { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
    .subtitle { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 4px; font-size: 14px; max-width: 90%; text-align: center; white-space: pre-wrap; word-wrap: break-word; transition: opacity 0.3s; }
    .subtitle.interim { color: #aaa; }
    .subtitle-container { margin-top: 15px; min-height: 60px; background: #1e1e1e; border-radius: 8px; padding: 15px; }
    .subtitle-text { color: white; font-size: 16px; line-height: 1.5; }
    .subtitle-text .interim { color: #888; }
    .subtitle-history { max-height: 150px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #2d2d2d; border-radius: 4px; }
    .subtitle-history p { margin: 5px 0; color: #ccc; font-size: 13px; }
    .subtitle-history p .speaker { color: #4fc3f7; font-weight: bold; }
    .subtitle-history p .time { color: #888; font-size: 11px; }
  </style>
</head>
<body>
  <h1>LiveKit MSA Server Test</h1>

  <div class="card">
    <h2>Server Status</h2>
    <div id="health-status" class="status">Checking...</div>
    <button onclick="checkHealth()">Refresh Status</button>
  </div>

  <div class="card">
    <h2>Create Room</h2>
    <div class="flex">
      <input type="text" id="room-name" placeholder="Room name" value="test-room">
      <input type="number" id="max-participants" placeholder="Max participants" value="10">
      <button class="success" onclick="createRoom()">Create Room</button>
    </div>
  </div>

  <div class="card">
    <h2>Rooms</h2>
    <button onclick="listRooms()">Refresh Rooms</button>
    <div id="rooms-list"></div>
  </div>

  <div class="card">
    <h2>Join Room</h2>
    <div class="flex">
      <select id="join-room-select"></select>
      <input type="text" id="user-identity" placeholder="Your identity" value="user1">
      <input type="text" id="user-name" placeholder="Your name" value="Test User">
      <button class="success" onclick="joinRoom()">Join Room</button>
      <button class="danger" onclick="leaveRoom()">Leave Room</button>
    </div>
    <div id="video-container"></div>
    <div id="connection-status" style="margin-top: 10px;"></div>
  </div>

  <div class="card" id="subtitle-card" style="display: none;">
    <h2>Live Subtitles</h2>
    <div class="flex">
      <button id="stt-toggle" class="warning" onclick="toggleSTT()">Start Speech Recognition</button>
      <select id="stt-language">
        <option value="ko-KR">Korean</option>
        <option value="en-US">English</option>
        <option value="ja-JP">Japanese</option>
        <option value="zh-CN">Chinese</option>
      </select>
    </div>
    <div class="subtitle-container">
      <div id="current-subtitle" class="subtitle-text">Speech recognition not started...</div>
    </div>
    <div class="subtitle-history" id="subtitle-history">
      <p style="color: #666;">Subtitle history will appear here...</p>
    </div>
  </div>

  <div class="card">
    <h2>API Response</h2>
    <pre id="response">Click a button to see the response...</pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js"></script>
  <script>
    const API_URL = 'http://localhost:3000';
    let room = null;
    let recognition = null;
    let isRecognizing = false;

    function showResponse(data, isError = false) {
      const pre = document.getElementById('response');
      pre.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
      pre.style.color = isError ? '#f48771' : '#d4d4d4';
    }

    async function apiCall(method, endpoint, body = null) {
      try {
        const options = {
          method,
          headers: { 'Content-Type': 'application/json' },
        };
        if (body) options.body = JSON.stringify(body);

        const res = await fetch(`${API_URL}${endpoint}`, options);
        const data = await res.json();

        if (!res.ok) throw data;
        showResponse(data);
        return data;
      } catch (err) {
        showResponse(err, true);
        throw err;
      }
    }

    async function checkHealth() {
      const statusEl = document.getElementById('health-status');
      try {
        const data = await apiCall('GET', '/health');
        statusEl.textContent = `Server OK - ${data.status}`;
        statusEl.className = 'status ok';
      } catch (err) {
        statusEl.textContent = 'Server Error';
        statusEl.className = 'status error';
      }
    }

    async function createRoom() {
      const name = document.getElementById('room-name').value;
      const maxParticipants = parseInt(document.getElementById('max-participants').value) || 10;

      await apiCall('POST', '/rooms', {
        name,
        emptyTimeout: 300,
        maxParticipants
      });
      listRooms();
    }

    async function listRooms() {
      try {
        const rooms = await apiCall('GET', '/rooms');
        const listEl = document.getElementById('rooms-list');
        const selectEl = document.getElementById('join-room-select');

        if (rooms.length === 0) {
          listEl.innerHTML = '<p style="color: #888;">No rooms available</p>';
          selectEl.innerHTML = '<option value="">No rooms</option>';
          return;
        }

        listEl.innerHTML = rooms.map(r => `
          <div class="room-item">
            <span><strong>${r.name}</strong> (${r.numParticipants}/${r.maxParticipants} participants)</span>
            <button class="danger" onclick="deleteRoom('${r.name}')">Delete</button>
          </div>
        `).join('');

        selectEl.innerHTML = rooms.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteRoom(name) {
      if (!confirm(`Delete room "${name}"?`)) return;
      await apiCall('DELETE', `/rooms/${name}`);
      listRooms();
    }

    async function joinRoom() {
      const roomName = document.getElementById('join-room-select').value;
      const identity = document.getElementById('user-identity').value;
      const name = document.getElementById('user-name').value;
      const statusEl = document.getElementById('connection-status');

      if (!roomName) {
        alert('Please select a room');
        return;
      }

      // 먼저 카메라/마이크 권한 요청
      statusEl.innerHTML = '<span class="status">Requesting camera/mic permission...</span>';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        stream.getTracks().forEach(track => track.stop()); // 권한만 받고 스트림은 닫음
        statusEl.innerHTML = '<span class="status ok">Permission granted! Connecting...</span>';
      } catch (err) {
        statusEl.innerHTML = `<span class="status error">Permission denied: ${err.message}</span>`;
        showResponse({ error: 'Camera/Mic permission denied', details: err.message }, true);
        return;
      }

      try {
        const data = await apiCall('POST', `/rooms/${roomName}/join`, {
          identity,
          name,
          roomName
        });

        // LiveKit 연결
        await connectToRoom(data.token, roomName);
      } catch (err) {
        console.error(err);
      }
    }

    async function connectToRoom(token, roomName) {
      const statusEl = document.getElementById('connection-status');
      const containerEl = document.getElementById('video-container');

      if (room) {
        await room.disconnect();
      }

      room = new LivekitClient.Room({
        adaptiveStream: true,
        dynacast: true,
      });

      room.on(LivekitClient.RoomEvent.Connected, () => {
        statusEl.innerHTML = '<span class="status ok">Connected to ' + roomName + '</span>';
        // Show subtitle card when connected
        document.getElementById('subtitle-card').style.display = 'block';
      });

      room.on(LivekitClient.RoomEvent.Disconnected, () => {
        statusEl.innerHTML = '<span class="status error">Disconnected</span>';
        containerEl.innerHTML = '';
        document.getElementById('subtitle-card').style.display = 'none';
        stopSTT();
      });

      room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
        if (track.kind === 'video') {
          const videoEl = track.attach();
          const wrapper = document.createElement('div');
          wrapper.className = 'video-box';
          wrapper.id = `video-${participant.identity}`;
          wrapper.innerHTML = `<div class="video-label">${participant.identity}</div><div class="subtitle" id="subtitle-${participant.identity}" style="display:none;"></div>`;
          wrapper.prepend(videoEl);
          containerEl.appendChild(wrapper);
        }
      });

      room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
        const wrapper = document.getElementById(`video-${participant.identity}`);
        if (wrapper) wrapper.remove();
      });

      room.on(LivekitClient.RoomEvent.LocalTrackPublished, (publication) => {
        if (publication.kind === 'video') {
          const track = publication.track;
          const videoEl = track.attach();
          const wrapper = document.createElement('div');
          wrapper.className = 'video-box';
          wrapper.id = 'video-local';
          wrapper.innerHTML = '<div class="video-label">You</div><div class="subtitle" id="subtitle-local" style="display:none;"></div>';
          wrapper.prepend(videoEl);
          containerEl.appendChild(wrapper);
        }
      });

      // Handle data messages for subtitles from other participants
      room.on(LivekitClient.RoomEvent.DataReceived, (payload, participant) => {
        try {
          const data = JSON.parse(new TextDecoder().decode(payload));
          if (data.type === 'subtitle') {
            showRemoteSubtitle(participant.identity, data.text, data.isFinal);
          }
        } catch (e) {
          console.error('Failed to parse data message', e);
        }
      });

      try {
        statusEl.innerHTML = '<span class="status">Connecting...</span>';
        // localhost에서 테스트할 때는 livekit 서버 주소를 localhost로 변경
        await room.connect('ws://localhost:7880', token);

        // 카메라/마이크 활성화
        await room.localParticipant.enableCameraAndMicrophone();
      } catch (err) {
        statusEl.innerHTML = `<span class="status error">Connection failed: ${err.message}</span>`;
        showResponse(err.message, true);
      }
    }

    async function leaveRoom() {
      stopSTT();
      if (room) {
        await room.disconnect();
        room = null;
        document.getElementById('video-container').innerHTML = '';
        document.getElementById('connection-status').innerHTML = '<span class="status">Disconnected</span>';
        document.getElementById('subtitle-card').style.display = 'none';
      }
    }

    // Speech-to-Text Functions
    function initSTT() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Speech recognition is not supported in this browser. Please use Chrome.');
        return false;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = document.getElementById('stt-language').value;

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        // Update local subtitle display
        const currentSubtitle = document.getElementById('current-subtitle');
        if (finalTranscript) {
          currentSubtitle.innerHTML = finalTranscript;
          addToHistory(document.getElementById('user-name').value || 'You', finalTranscript);
          showLocalSubtitle(finalTranscript, true);
          sendSubtitleToRoom(finalTranscript, true);
        } else if (interimTranscript) {
          currentSubtitle.innerHTML = `${interimTranscript}<span class="interim">...</span>`;
          showLocalSubtitle(interimTranscript, false);
          sendSubtitleToRoom(interimTranscript, false);
        }
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          // Restart if no speech detected
          if (isRecognizing) {
            recognition.stop();
            setTimeout(() => {
              if (isRecognizing) recognition.start();
            }, 100);
          }
        }
      };

      recognition.onend = () => {
        // Restart if still supposed to be recognizing
        if (isRecognizing) {
          setTimeout(() => {
            try {
              recognition.start();
            } catch (e) {
              console.error('Failed to restart recognition:', e);
            }
          }, 100);
        }
      };

      return true;
    }

    function toggleSTT() {
      if (isRecognizing) {
        stopSTT();
      } else {
        startSTT();
      }
    }

    function startSTT() {
      if (!recognition && !initSTT()) return;

      recognition.lang = document.getElementById('stt-language').value;

      try {
        recognition.start();
        isRecognizing = true;
        const btn = document.getElementById('stt-toggle');
        btn.textContent = 'Stop Speech Recognition';
        btn.classList.add('active');
        btn.classList.remove('warning');
        btn.classList.add('danger');
        document.getElementById('current-subtitle').textContent = 'Listening...';
      } catch (e) {
        console.error('Failed to start recognition:', e);
      }
    }

    function stopSTT() {
      if (recognition) {
        isRecognizing = false;
        recognition.stop();
        const btn = document.getElementById('stt-toggle');
        btn.textContent = 'Start Speech Recognition';
        btn.classList.remove('active');
        btn.classList.remove('danger');
        btn.classList.add('warning');
        document.getElementById('current-subtitle').textContent = 'Speech recognition stopped.';
        hideLocalSubtitle();
      }
    }

    function showLocalSubtitle(text, isFinal) {
      const subtitleEl = document.getElementById('subtitle-local');
      if (subtitleEl) {
        subtitleEl.textContent = text;
        subtitleEl.style.display = 'block';
        subtitleEl.className = isFinal ? 'subtitle' : 'subtitle interim';

        if (isFinal) {
          // Hide after 3 seconds for final results
          setTimeout(() => {
            subtitleEl.style.display = 'none';
          }, 3000);
        }
      }
    }

    function hideLocalSubtitle() {
      const subtitleEl = document.getElementById('subtitle-local');
      if (subtitleEl) {
        subtitleEl.style.display = 'none';
      }
    }

    function showRemoteSubtitle(identity, text, isFinal) {
      const subtitleEl = document.getElementById(`subtitle-${identity}`);
      if (subtitleEl) {
        subtitleEl.textContent = text;
        subtitleEl.style.display = 'block';
        subtitleEl.className = isFinal ? 'subtitle' : 'subtitle interim';

        if (isFinal) {
          addToHistory(identity, text);
          // Hide after 3 seconds for final results
          setTimeout(() => {
            subtitleEl.style.display = 'none';
          }, 3000);
        }
      }
    }

    function sendSubtitleToRoom(text, isFinal) {
      if (room && room.localParticipant) {
        const data = JSON.stringify({
          type: 'subtitle',
          text: text,
          isFinal: isFinal
        });
        room.localParticipant.publishData(new TextEncoder().encode(data), { reliable: isFinal });
      }
    }

    function addToHistory(speaker, text) {
      const historyEl = document.getElementById('subtitle-history');
      const time = new Date().toLocaleTimeString();

      // Remove placeholder if exists
      const placeholder = historyEl.querySelector('p[style*="color: #666"]');
      if (placeholder) placeholder.remove();

      const entry = document.createElement('p');
      entry.innerHTML = `<span class="time">[${time}]</span> <span class="speaker">${speaker}:</span> ${text}`;
      historyEl.appendChild(entry);
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    // Language change handler
    document.getElementById('stt-language').addEventListener('change', () => {
      if (isRecognizing) {
        stopSTT();
        setTimeout(startSTT, 100);
      }
    });

    // 초기화
    checkHealth();
    listRooms();
  </script>
</body>
</html>
