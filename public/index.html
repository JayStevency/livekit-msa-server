<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Chat - EXAONE 3.5</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: rgba(255,255,255,0.05);
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      color: #fff;
      font-size: 20px;
      font-weight: 600;
    }
    .header .model-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .header .status {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #888;
      font-size: 13px;
    }
    .header .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
    }
    .header .status-dot.error { background: #ef4444; }

    .chat-container {
      flex: 1;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      display: flex;
      gap: 12px;
      max-width: 85%;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user { align-self: flex-end; flex-direction: row-reverse; }

    .message .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .message.user .avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .message.assistant .avatar { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }

    .message .content {
      background: rgba(255,255,255,0.08);
      padding: 14px 18px;
      border-radius: 18px;
      color: #e5e5e5;
      line-height: 1.6;
      font-size: 15px;
    }
    .message.user .content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.assistant .content { border-bottom-left-radius: 4px; }

    .message .content pre {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }
    .message .content code {
      background: rgba(0,0,0,0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 14px 18px;
      background: rgba(255,255,255,0.08);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      width: fit-content;
    }
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #888;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-8px); }
    }

    /* Voice Control Area */
    .voice-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px;
    }

    .mic-button {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    }
    .mic-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5);
    }
    .mic-button.listening {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      animation: pulse-ring 1.5s infinite;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
    }
    .mic-button.speaking {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      box-shadow: 0 4px 20px rgba(34, 197, 94, 0.5);
    }
    .mic-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .mic-button svg {
      width: 36px;
      height: 36px;
      fill: white;
    }

    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .voice-status {
      color: #888;
      font-size: 14px;
      text-align: center;
      min-height: 24px;
    }
    .voice-status.listening { color: #ef4444; }
    .voice-status.speaking { color: #22c55e; }
    .voice-status.processing { color: #f59e0b; }

    .transcript {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px 16px;
      color: #ccc;
      font-size: 14px;
      min-height: 48px;
      width: 100%;
      max-width: 600px;
      text-align: center;
    }
    .transcript.interim { color: #888; font-style: italic; }

    .controls {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    .controls button {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      color: #888;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .controls button:hover {
      background: rgba(255,255,255,0.12);
      color: #fff;
    }
    .controls select {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      color: #ccc;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .controls select option {
      background: #1a1a2e;
      color: #fff;
    }

    .welcome {
      text-align: center;
      color: #888;
      padding: 40px 20px;
    }
    .welcome h2 {
      color: #fff;
      font-size: 24px;
      margin-bottom: 12px;
    }
    .welcome p {
      font-size: 14px;
      line-height: 1.8;
    }

    .instructions {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px 20px;
      margin-top: 20px;
      text-align: left;
      display: inline-block;
    }
    .instructions h3 {
      color: #fff;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .instructions ol {
      color: #aaa;
      font-size: 13px;
      padding-left: 20px;
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Voice Chat</h1>
    <span class="model-badge" id="model-badge">EXAONE 3.5</span>
    <div class="status">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">Connecting...</span>
    </div>
  </div>

  <div class="chat-container">
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <h2>EXAONE 3.5ì™€ ìŒì„± ëŒ€í™”</h2>
        <p>ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.<br>AIê°€ ìŒì„±ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.</p>
        <div class="instructions">
          <h3>ì‚¬ìš© ë°©ë²•</h3>
          <ol>
            <li>ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­ (ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë°”)</li>
            <li>ë§í•˜ê¸° (ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤)</li>
            <li>ë§ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ AIê°€ ì‘ë‹µ</li>
            <li>AI ì‘ë‹µì´ ìŒì„±ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤</li>
          </ol>
        </div>
      </div>
    </div>

    <div class="voice-control">
      <div class="transcript" id="transcript">ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>

      <button class="mic-button" id="mic-btn" onclick="toggleListening()">
        <svg id="mic-icon" viewBox="0 0 24 24">
          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
      </button>

      <div class="voice-status" id="voice-status">ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆ„ë¥´ì„¸ìš”</div>

      <div class="controls">
        <select id="voice-select" onchange="updateVoice()">
          <option value="">ìŒì„± ì„ íƒ...</option>
        </select>
        <button onclick="clearChat()">ëŒ€í™” ì´ˆê¸°í™”</button>
        <button onclick="stopSpeaking()">ìŒì„± ì¤‘ì§€</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000';
    let conversationId = null;
    let isListening = false;
    let isProcessing = false;
    let isSpeaking = false;
    let recognition = null;
    let synthesis = window.speechSynthesis;
    let selectedVoice = null;
    let silenceTimer = null;

    // Initialize
    async function init() {
      await checkStatus();
      initSpeechRecognition();
      loadVoices();

      // Spacebar to toggle listening
      document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          toggleListening();
        }
      });
    }

    // Check server status
    async function checkStatus() {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      const badge = document.getElementById('model-badge');

      try {
        const res = await fetch(`${API_URL}/health`);
        if (res.ok) {
          dot.className = 'status-dot';
          text.textContent = 'Connected';

          // Get model name
          const testRes = await fetch(`${API_URL}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: 'hi' })
          });
          if (testRes.ok) {
            const data = await testRes.json();
            badge.textContent = data.model || 'EXAONE 3.5';
          }
        } else {
          throw new Error('Server error');
        }
      } catch (err) {
        dot.className = 'status-dot error';
        text.textContent = 'Disconnected';
      }
    }

    // Initialize Speech Recognition
    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onstart = () => {
        isListening = true;
        updateUI();
      };

      recognition.onend = () => {
        isListening = false;
        updateUI();

        // Restart if should still be listening
        if (document.getElementById('mic-btn').classList.contains('listening') && !isProcessing) {
          try { recognition.start(); } catch(e) {}
        }
      };

      recognition.onresult = (event) => {
        clearTimeout(silenceTimer);

        let finalTranscript = '';
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        const transcriptEl = document.getElementById('transcript');

        if (finalTranscript) {
          transcriptEl.textContent = finalTranscript;
          transcriptEl.classList.remove('interim');

          // Wait for potential more speech, then send
          silenceTimer = setTimeout(() => {
            if (finalTranscript.trim()) {
              stopListening();
              sendVoiceMessage(finalTranscript.trim());
            }
          }, 1500);
        } else if (interimTranscript) {
          transcriptEl.textContent = interimTranscript + '...';
          transcriptEl.classList.add('interim');
        }
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          // Restart on no speech
          if (isListening) {
            try { recognition.start(); } catch(e) {}
          }
        }
      };
    }

    // Load available voices
    function loadVoices() {
      const voiceSelect = document.getElementById('voice-select');

      function populateVoices() {
        const voices = synthesis.getVoices();
        const koreanVoices = voices.filter(v => v.lang.startsWith('ko'));

        voiceSelect.innerHTML = '<option value="">ìŒì„± ì„ íƒ...</option>';

        // Add Korean voices first
        koreanVoices.forEach((voice, i) => {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = `${voice.name} (í•œêµ­ì–´)`;
          if (i === 0) {
            option.selected = true;
            selectedVoice = voice;
          }
          voiceSelect.appendChild(option);
        });

        // Add other voices
        voices.filter(v => !v.lang.startsWith('ko')).forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = `${voice.name} (${voice.lang})`;
          voiceSelect.appendChild(option);
        });
      }

      populateVoices();
      if (synthesis.onvoiceschanged !== undefined) {
        synthesis.onvoiceschanged = populateVoices;
      }
    }

    function updateVoice() {
      const voiceName = document.getElementById('voice-select').value;
      const voices = synthesis.getVoices();
      selectedVoice = voices.find(v => v.name === voiceName) || null;
    }

    function toggleListening() {
      if (isProcessing || isSpeaking) return;

      if (isListening) {
        stopListening();
      } else {
        startListening();
      }
    }

    function startListening() {
      if (!recognition) {
        initSpeechRecognition();
      }

      stopSpeaking();

      try {
        recognition.start();
        document.getElementById('mic-btn').classList.add('listening');
        document.getElementById('transcript').textContent = 'ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
        document.getElementById('transcript').classList.add('interim');
      } catch (e) {
        console.error('Failed to start recognition:', e);
      }
    }

    function stopListening() {
      clearTimeout(silenceTimer);
      document.getElementById('mic-btn').classList.remove('listening');

      if (recognition) {
        try { recognition.stop(); } catch(e) {}
      }
      isListening = false;
      updateUI();
    }

    function updateUI() {
      const btn = document.getElementById('mic-btn');
      const status = document.getElementById('voice-status');

      btn.disabled = isProcessing;

      if (isSpeaking) {
        btn.classList.remove('listening');
        btn.classList.add('speaking');
        status.textContent = 'AIê°€ ë§í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        status.className = 'voice-status speaking';
      } else if (isProcessing) {
        btn.classList.remove('listening', 'speaking');
        status.textContent = 'ì‘ë‹µ ìƒì„± ì¤‘...';
        status.className = 'voice-status processing';
      } else if (isListening) {
        btn.classList.add('listening');
        btn.classList.remove('speaking');
        status.textContent = 'ë“£ê³  ìˆìŠµë‹ˆë‹¤... (ë§ì”€í•˜ì„¸ìš”)';
        status.className = 'voice-status listening';
      } else {
        btn.classList.remove('listening', 'speaking');
        status.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆ„ë¥´ì„¸ìš”';
        status.className = 'voice-status';
      }
    }

    async function sendVoiceMessage(message) {
      if (!message || isProcessing) return;

      isProcessing = true;
      updateUI();

      // Remove welcome
      const welcome = document.getElementById('welcome');
      if (welcome) welcome.remove();

      // Add user message
      addMessage('user', message);
      showTyping();

      try {
        const res = await fetch(`${API_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, conversationId })
        });

        hideTyping();

        if (res.ok) {
          const data = await res.json();
          conversationId = data.conversationId;
          addMessage('assistant', data.message);

          // Speak the response
          speak(data.message);
        } else {
          const errMsg = 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          addMessage('assistant', errMsg);
          speak(errMsg);
        }
      } catch (err) {
        hideTyping();
        const errMsg = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        addMessage('assistant', errMsg);
        speak(errMsg);
      }

      isProcessing = false;
      updateUI();
    }

    function speak(text) {
      // Cancel any ongoing speech
      synthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ko-KR';
      utterance.rate = 1.0;
      utterance.pitch = 1.0;

      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }

      utterance.onstart = () => {
        isSpeaking = true;
        updateUI();
      };

      utterance.onend = () => {
        isSpeaking = false;
        updateUI();
        document.getElementById('transcript').textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³„ì† ëŒ€í™”í•˜ì„¸ìš”';
      };

      utterance.onerror = () => {
        isSpeaking = false;
        updateUI();
      };

      synthesis.speak(utterance);
    }

    function stopSpeaking() {
      synthesis.cancel();
      isSpeaking = false;
      updateUI();
    }

    function addMessage(role, content) {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${role}`;

      const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
      const formattedContent = formatMessage(content);

      div.innerHTML = `
        <div class="avatar">${avatar}</div>
        <div class="content">${formattedContent}</div>
      `;

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function formatMessage(content) {
      return content
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
    }

    function showTyping() {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message assistant';
      div.id = 'typing';
      div.innerHTML = `
        <div class="avatar">ğŸ¤–</div>
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      `;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    }

    async function clearChat() {
      stopSpeaking();
      stopListening();

      if (conversationId) {
        try {
          await fetch(`${API_URL}/chat/clear`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conversationId })
          });
        } catch (err) {}
      }

      conversationId = null;
      const messages = document.getElementById('messages');
      messages.innerHTML = `
        <div class="welcome" id="welcome">
          <h2>EXAONE 3.5ì™€ ìŒì„± ëŒ€í™”</h2>
          <p>ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.<br>AIê°€ ìŒì„±ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.</p>
          <div class="instructions">
            <h3>ì‚¬ìš© ë°©ë²•</h3>
            <ol>
              <li>ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­ (ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë°”)</li>
              <li>ë§í•˜ê¸° (ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤)</li>
              <li>ë§ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ AIê°€ ì‘ë‹µ</li>
              <li>AI ì‘ë‹µì´ ìŒì„±ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤</li>
            </ol>
          </div>
        </div>
      `;
      document.getElementById('transcript').textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”';
    }

    // Start
    init();
  </script>
</body>
</html>
